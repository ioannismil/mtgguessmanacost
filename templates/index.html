<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Guess the Mana Cost</title>
  <style>
    :root {
      --bg-color: #20232a;
      --text-color: #fff;
      --accent: #61dafb;
      --card-width: 90vw;
      --card-max-width: 320px;
    }

    body {
      margin: 0;
      padding: 0;
      text-align: center;
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      overflow-x: hidden;
    }

    h1 {
      font-size: clamp(1.5rem, 5vw, 2rem);
      margin-top: 1rem;
    }

    #stats {
      margin: 0.5rem 0;
      font-size: 1.1rem;
    }

    #instructions {
      color: #ccc;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
      padding: 0 1rem;
    }

    .card-container {
      position: relative;
      display: inline-block;
      margin: 1rem 0;
    }

    .card-image {
      width: var(--card-width);
      max-width: var(--card-max-width);
      border-radius: 10px;
      box-shadow: 0 0 10px #444;
      transition: transform 0.3s ease;
    }

    .hide-mana-cost {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 30%;
      height: 10%;
      background: rgba(32, 35, 42, 1);
      border-top-right-radius: 10px;
      border-bottom-left-radius: 40px;
    }

    .mana-symbol {
      width: 38px;
      height: 38px;
      margin: 5px;
      vertical-align: middle;
      cursor: pointer;
      transition: transform 0.1s, opacity 0.2s;
      touch-action: manipulation;
    }

    .mana-symbol:hover {
      transform: scale(1.2);
    }

    .guess-display {
      margin: 0.5rem 0;
      min-height: 44px;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 5px;
    }

    #mana-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(50px, 1fr));
      gap: 6px;
      max-width: 360px;
      margin: 0 auto;
      justify-items: center;
    }

    button {
      padding: 10px 18px;
      margin: 8px 5px;
      background-color: var(--accent);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      color: #000;
      transition: background 0.3s, transform 0.1s;
      font-size: 1rem;
      touch-action: manipulation;
    }

    button:hover:not(:disabled) {
      background-color: #52c0e8;
      transform: scale(1.05);
    }

    button:disabled {
      opacity: 0.5;
      pointer-events: none;
    }

    #message {
      margin: 1rem;
      font-size: 1.1rem;
      min-height: 2rem;
    }

    @media (min-width: 768px) {
      .mana-symbol {
        width: 45px;
        height: 45px;
      }
      #mana-buttons {
        max-width: 500px;
      }
    }
  </style>
</head>
<body>
  <h1>Guess the Mana Cost</h1>
  <div id="stats">
    Lives: <span id="lives">{{ lives }}</span> | Score: <span id="score">{{ score }}</span>
  </div>

  <div id="instructions">
    Tap the mana symbols to build your guess.<br>
    If the card has <b>no mana cost</b>, just press <b>Guess</b>.
  </div>
<div class="set-filter">
  <label for="setSelect">Filter by Set:</label>
  <select id="setSelect">
    <option value="">All Sets</option>
  </select>
</div>
  <div id="card-container"></div>
    <div>
    <button onclick="undoGuess()">Undo</button>
    <button onclick="clearGuess()">Clear</button>
    <button onclick="submitGuess()" id="guessButton">Guess</button>
  </div>
  <div class="guess-display" id="guessDisplay"></div>
    <div id="message"></div>
  <div id="mana-buttons"></div>




  <script>
    window.onload = () => {
  loadSets();
  loadCard();
    document.getElementById("setSelect").addEventListener("change", resetGameOnSetChange);
};
    async function loadSets() {
  const res = await fetch("/get_sets");
  const sets = await res.json();

  const select = document.getElementById("setSelect");
  sets.forEach(s => {
    const option = document.createElement("option");
    option.value = s.code;
    option.textContent = `${s.name} (${s.code.toUpperCase()})`;
    select.appendChild(option);
  });
}
document.getElementById("setSelect").addEventListener("change", resetGameOnSetChange);
async function resetGameOnSetChange() {
  await fetch("/reset_game", { method: "POST" });
  
  document.getElementById("lives").textContent = "3";
  document.getElementById("score").textContent = "0";
  document.getElementById("message").textContent = "New set selected — game restarting!";
  currentGuess = [];
  renderGuess();

  loadCard();
}


    const manaSymbols = [
      "0","1","2","3","4","5","6","7","8","9","10",
      "W","U","B","R","G",
      "WU","UB","BR","RG","GW",
      "WP","UP","BP","RP","GP",
      "C","X"
    ];

    let currentGuess = [];
    let buttonsDisabled = false;
    let gameOver = false;

    function renderManaCost(manaCost) {
      if (!manaCost) return "";
      const symbols = manaCost.match(/\{.*?\}/g) || [];
      return symbols
        .map(sym => {
          const clean = sym.replace(/[{}]/g, "");
          const url = `https://svgs.scryfall.io/card-symbols/${clean}.svg`;
          return `<img src="${url}" class="mana-symbol" title="${sym}">`;
        })
        .join("");
    }

    function renderGuess() {
      const display = document.getElementById("guessDisplay");
      display.innerHTML = currentGuess
        .map(sym => `<img src="https://svgs.scryfall.io/card-symbols/${sym}.svg" class="mana-symbol">`)
        .join("");
    }

    function addSymbol(sym) {
      if (buttonsDisabled) return;
      currentGuess.push(sym);
      renderGuess();
    }

    function undoGuess() {
      if (buttonsDisabled) return;
      currentGuess.pop();
      renderGuess();
    }

    function clearGuess() {
      if (buttonsDisabled) return;
      currentGuess = [];
      renderGuess();
    }

    function renderManaButtons() {
      const container = document.getElementById("mana-buttons");
      container.innerHTML = manaSymbols
        .map(sym => `
          <img src="https://svgs.scryfall.io/card-symbols/${sym}.svg" 
               class="mana-symbol" 
               title="${sym}" 
               onclick="addSymbol('${sym}')">
        `).join("");
    }

    async function loadCard() {
      const selectedSet = document.getElementById("setSelect").value;
      const res = await fetch(`/get_card${selectedSet ? "?set=" + selectedSet : ""}`);
      const card = await res.json();

      const manaIcons = renderManaCost(card.mana_cost);

      document.getElementById("card-container").innerHTML = `
        <div class="card-container">
          ${card.image ? `<img src="${card.image}" class="card-image" alt="${card.name}" />` : ""}
          <div class="hide-mana-cost"></div>
        </div>
      `;

      document.getElementById("message").textContent = "";
      clearGuess();
      enableAllButtons();
      hideNextButton();
      gameOver = false;
    }

    function renderManaIconsFromCost(manaCost) {
  if (!manaCost) return "(No mana cost)";
  const symbols = manaCost.match(/\{.*?\}/g) || [];
  return symbols
    .map(sym => {
      const clean = sym.replace(/[{}]/g, "");
      const url = `https://svgs.scryfall.io/card-symbols/${clean}.svg`;
      return `<img src="${url}" class="mana-symbol" title="${sym}">`;
    })
    .join("");
}

async function submitGuess() {
  if (buttonsDisabled) return;
  disableAllButtons();

  const guess = currentGuess.length > 0 
      ? currentGuess.map(sym => `{${sym}}`).join("") 
      : "";

  const res = await fetch("/guess", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ guess })
  });

  const result = await res.json();

  // Show the result message
  document.getElementById("message").textContent = result.message;
  document.getElementById("lives").textContent = result.lives;
  document.getElementById("score").textContent = result.score;

  // Clear the previous guess and display the correct mana cost as SVGs
  currentGuess = [];
  renderGuess();
  document.getElementById("message").innerHTML += renderManaIconsFromCost(result.correct_cost || guess);

  if (result.game_over) {
    document.getElementById("message").textContent += " 💀 Game Over!";
    document.getElementById("message").innerHTML += renderManaIconsFromCost(result.correct_cost || guess);
    gameOver = true;
  }

  showNextButton();
}

    function showNextButton() {
      hideNextButton();
      const nextBtn = document.createElement("button");
      nextBtn.textContent = gameOver ? "Restart Game 🔄" : "Next Card ➡️";
      nextBtn.id = "nextButton";
      nextBtn.onclick = async () => {
        nextBtn.remove();
        if (gameOver) {
          await resetGame();
        }
        loadCard();
          currentGuess = [];
  renderGuess();
      };
      document.getElementById("message").appendChild(nextBtn);
    }

    function hideNextButton() {
      const btn = document.getElementById("nextButton");
      if (btn) btn.remove();
    }

    async function resetGame() {
      const res = await fetch("/reset", { method: "POST" });
      const result = await res.json();
      document.getElementById("lives").textContent = result.lives;
      document.getElementById("score").textContent = result.score;
      document.getElementById("message").textContent = "Game restarted! Try again!";
    }

    function disableAllButtons() {
      buttonsDisabled = true;
      document.querySelectorAll("button, .mana-symbol").forEach(el => el.style.pointerEvents = "none");
      document.querySelectorAll("button").forEach(el => el.disabled = true);
    }

    function enableAllButtons() {
      buttonsDisabled = false;
      document.querySelectorAll("button, .mana-symbol").forEach(el => el.style.pointerEvents = "auto");
      document.querySelectorAll("button").forEach(el => el.disabled = false);
    }

    renderManaButtons();
    loadCard();
  </script>
</body>
</html>
